<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Exploration App (Full Overlay)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/h3-js/3.7.2/h3-js.umd.min.js"></script>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(128, 128, 128, 0.8);
            pointer-events: none;
        }
        #startButton {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="overlay"></div>
    <button id="startButton">Start Exploring</button>

    <script>
        let map;
        let hexGrid = new Set();
        const hexResolution = 8; // Adjust this for different grid sizes

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 0, lng: 0},
                zoom: 2,
                disableDefaultUI: true
            });

            document.getElementById('startButton').addEventListener('click', startExploring);
        }

        function startExploring() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    initializeGrid,
                    handleLocationError,
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function initializeGrid(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            map.setCenter({lat, lng});
            map.setZoom(18);

            const centerHex = h3.latLngToCell(lat, lng, hexResolution);
            const hexRing = h3.gridDisk(centerHex, 5);

            hexRing.forEach(hexId => {
                drawHexagon(hexId);
            });
        }

        function drawHexagon(h3Index) {
            const hexBoundary = h3.cellToBoundary(h3Index);
            const hexCoords = hexBoundary.map(([lat, lng]) => ({lat, lng}));

            const hexagon = new google.maps.Polygon({
                paths: hexCoords,
                strokeColor: "#FFFFFF",
                strokeOpacity: 1,
                strokeWeight: 2,
                fillColor: "#808080",
                fillOpacity: 0,
                map: map
            });

            hexagon.addListener('click', function() {
                revealHexagon(h3Index, hexagon);
            });
        }

        function revealHexagon(h3Index, hexagon) {
            if (!hexGrid.has(h3Index)) {
                hexGrid.add(h3Index);
                hexagon.setOptions({
                    fillColor: "#FF0000",
                    fillOpacity: 0,
                    strokeColor: "#FF0000"
                });

                // Create a hole in the overlay
                const hexBoundary = h3.cellToBoundary(h3Index);
                const hexCoords = hexBoundary.map(([lat, lng]) => ({lat, lng}));
                
                new google.maps.Polygon({
                    paths: [
                        [{lat: -90, lng: -180}, {lat: -90, lng: 180}, {lat: 90, lng: 180}, {lat: 90, lng: -180}],
                        hexCoords
                    ],
                    strokeOpacity: 0,
                    fillColor: "#808080",
                    fillOpacity: 0.8,
                    map: map
                });
            }
        }

        function handleLocationError(error) {
            console.error("Geolocation error: " + error.message);
            alert("Unable to retrieve your location. Please ensure you've granted location permissions and try again.");
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDR3nhIW56taOqanoBa0I4nVJiiUvQylf4&callback=initMap" async defer></script>
</body>
</html>